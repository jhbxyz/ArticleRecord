# Java 线程同步与线程安全

* volatile
* synchronized

### 1.线程安全产生的原因

每一个线程都维护了自己的一块缓存区域，操作后再写回主内存中，这两个线程之间是数据区域是自己独有的，所以在操作同一个变量（共享变量）的时候比如 `t = t+1`，是在自己的工作内存中进行的，这样有可能会出现线程不同步问题，最终导致 t 的值不正确。

**共享变量：**上面我们所说的 t 就是一个共享变量，也就是说，能够被多个线程访问到的变量，我们称之为共享变量

### 2.volatile 关键字

- 可见性（变量的）

  在多线程环境下，某个共享变量如果被其中一个线程给修改了，其他线程能够立即知道这个共享变量已经被修改了，当其他线程要读取这个变量的时候，最终会去内存中读取，而不是从自己的**工作空间**中读取。

- 有序性（代码的有序性）

  * 代码写好之后，虚拟机不一定会按照我们写的代码的顺序来执行，虚拟机在进行代码编译优化的时候，对于那些改变顺序之后不会对最终变量的值造成影响的代码，是有可能将他们进行重排序的。
  * volatile 关键字保证了有序性

#### 2.1.volatile关键字是如何保证线程安全问题的

在多线程环境下，某个共享变量如果被其中一个线程给修改了，其他线程能够立即知道这个**共享变量**（堆，方法区）已经被修改了，当其他线程要读取这个变量的时候，最终会去**内存**中读取，而不是从自己的**工作空间**（线程自己的工作区）中读取

**变量**被声明为volatile，那么这个变量就具有了**可见性**的性质了

#### 2.2.volatile真的能完全保证一个变量的线程安全吗？

答案是**否定**的。原因是因为Java里面的运算并非是**原子操作**。

**原子操作**：即一个操作或者多个操作 要么**全部执行并且执行的过程不会被任何因素打断，要么就都不执行**。
也就是说，处理器要嘛把这组操作全部执行完，中间不允许被其他操作所打断，要嘛这组操作不要执行。
刚才说Java里面的运行并非是原子操作。

atomic类有 AtomicInteger AtomicBoolean 等类，作⽤和 volatile 基本⼀致，可以看做是通⽤版的 volatile。

#### 2.3.什么情况下volatile能够保证线程安全

- 运算结果并不依赖变量的当前值，或者能够确保只有单一的线程修改变量的值。
- 变量不需要与其他状态变量共同参与不变约束。

### 3.synchronized 关键字

#### 3.1.synchronized 锁住的是代码还是对象

synchronized锁住的是括号里的**对象**，而不是代码。对于非static的synchronized方法，锁的就是对象本身也就是this（建议使用字节码文件对象）

我们在用synchronized关键字的时候，能缩小代码段的范围就尽量缩小，能在代码段上加同步就不要再整个方法上加同步。这叫**减小锁的粒度**，使代码更大程度的并发

**static synchronized**方法，static方法可以直接类名加方法名调用，方法中无法使用this，所以它锁的不是this，而是类的Class对象，所以，static synchronized方法也相当于全局锁，相当于锁住了代码段

#### 3.2.synchronized的使用总结

```java
/**
 * 同步方法
 */
private synchronized void sys1() {
    //锁对象为当前类对象 this
}

/**
 * 同步代码块
 */
private void sys2() {
    //锁对象为 synchronized 块上的参数
    synchronized (this) {

    }
}

/**
 * 静态同步方法
 */
public static synchronized void sys3() {
    //锁对象为类的Class对象
}
```

- 同步方法：锁的就是对象本身也就是this
- 同步代码块: 方法参数的对象 一般是 Class 对象
- 静态同步方法：类的Class对象相当于全局锁

#### 3.2.synchronized的作用

- 保证⽅法内部或代码块内部资源（数据）的**互斥**访问。即同⼀时间、由同⼀个 Monitor 监视的代码，最多只能有⼀个线程在访问

- 保证线程之间对监视资源的数据同步。即任何线程在获取到 Monitor后的第⼀时间，会先将共享内存中的数据复制到⾃⼰的缓存中；任何线程在释放 Monitor 的第⼀时间，会先将缓存中的数据复制到共享内存中。

### 

### 参考资料

[线程安全(上)--彻底搞懂volatile关键字](https://www.cnblogs.com/kubidemanong/p/9505944.html)